version: '3.8'

services:
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: ib-gateway
    restart: unless-stopped

    # IMPORTANT: container uses 4004 for paper API, 4003 for live API
    ports:
      - "4002:4004"   # host 4002 -> container 4004 (paper API)
      # - "4001:4003" # optional: host 4001 -> container 4003 (live API)
      - "5900:5900"   # VNC server

    volumes:
      - ib-gateway-data:/home/ibgateway/Jts

    environment:
      TWS_USERID: ${IBKR_USERNAME}
      TWS_PASSWORD: ${IBKR_PASSWORD}
      TRADING_MODE: paper
      READ_ONLY_API: "no"
      TIMEZONE: America/New_York

      VNC_SERVER_PASSWORD: ${VNC_SERVER_PASSWORD}
      VNC_SERVER_PORT: "5900"

    networks:
      - ib-network
      - proxy

  ib-novnc:
    image: theasp/novnc:latest
    container_name: ib-novnc
    restart: unless-stopped
    environment:
      # noVNC connects to the VNC server inside ib-gateway
      VNC_HOST: ib-gateway
      VNC_PORT: "5900"
    networks:
      - proxy
      - ib-network
    depends_on:
      - ib-gateway

volumes:
  ib-gateway-data:
    driver: local

networks:
  ib-network:
    driver: bridge
  proxy:
    external: true